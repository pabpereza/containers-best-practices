name: PR - Build and Compare Docker Images

on:
  pull_request:
    branches: [main]

jobs:
  # Job 1: Discover all Dockerfiles and create the build matrix
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.find.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find all Dockerfiles
        id: find
        run: |
          # Find all Dockerfiles (excluding .old files)
          DOCKERFILES=$(find . -type f \( -iname "dockerfile" -o -iname "Dockerfile" \) ! -iname "*.old" | sort)
          
          echo "Found Dockerfiles:"
          echo "$DOCKERFILES"
          
          # Build JSON matrix
          MATRIX_JSON="["
          FIRST=true
          
          for dockerfile in $DOCKERFILES; do
            dir=$(dirname "$dockerfile" | sed 's|^\./||')
            dockerfile_name=$(basename "$dockerfile")
            
            # Check for .old dockerfile
            HAS_OLD="false"
            OLD_DOCKERFILE=""
            if [ -f "$dir/${dockerfile_name}.old" ]; then
              HAS_OLD="true"
              OLD_DOCKERFILE="${dockerfile_name}.old"
            elif [ -f "$dir/Dockerfile.old" ]; then
              HAS_OLD="true"
              OLD_DOCKERFILE="Dockerfile.old"
            elif [ -f "$dir/dockerfile.old" ]; then
              HAS_OLD="true"
              OLD_DOCKERFILE="dockerfile.old"
            fi
            
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              MATRIX_JSON+=","
            fi
            
            MATRIX_JSON+="{\"dir\":\"$dir\",\"dockerfile\":\"$dockerfile_name\",\"has_old\":$HAS_OLD,\"old_dockerfile\":\"$OLD_DOCKERFILE\"}"
          done
          
          MATRIX_JSON+="]"
          
          echo "Matrix JSON:"
          echo "$MATRIX_JSON"
          
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  # Job 2: Build each Dockerfile in parallel
  build:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build optimized Dockerfile
        id: build_new
        run: |
          echo "üì¶ Building ${{ matrix.dir }}/${{ matrix.dockerfile }}..."
          
          IMAGE_NAME="test-new-$(echo '${{ matrix.dir }}' | tr '/' '-')"
          
          # Measure build time
          START_TIME=$(date +%s)
          
          if docker build -t "$IMAGE_NAME" -f "${{ matrix.dir }}/${{ matrix.dockerfile }}" "${{ matrix.dir }}"; then
            END_TIME=$(date +%s)
            BUILD_TIME=$((END_TIME - START_TIME))
            
            # Format time as minutes:seconds
            MINUTES=$((BUILD_TIME / 60))
            SECONDS=$((BUILD_TIME % 60))
            if [ $MINUTES -gt 0 ]; then
              TIME_STR="${MINUTES}m ${SECONDS}s"
            else
              TIME_STR="${SECONDS}s"
            fi
            
            SIZE=$(docker images --format "{{.Size}}" "$IMAGE_NAME")
            echo "size=$SIZE" >> $GITHUB_OUTPUT
            echo "time=$TIME_STR" >> $GITHUB_OUTPUT
            echo "‚úÖ Built successfully: $SIZE in $TIME_STR"
          else
            END_TIME=$(date +%s)
            BUILD_TIME=$((END_TIME - START_TIME))
            echo "size=Build Failed" >> $GITHUB_OUTPUT
            echo "time=-" >> $GITHUB_OUTPUT
            echo "‚ùå Build failed after ${BUILD_TIME}s"
          fi

      - name: Build old Dockerfile
        id: build_old
        if: matrix.has_old == true
        run: |
          echo "üì¶ Building ${{ matrix.dir }}/${{ matrix.old_dockerfile }}..."
          
          IMAGE_NAME="test-old-$(echo '${{ matrix.dir }}' | tr '/' '-')"
          
          if docker build -t "$IMAGE_NAME" -f "${{ matrix.dir }}/${{ matrix.old_dockerfile }}" "${{ matrix.dir }}"; then
            SIZE=$(docker images --format "{{.Size}}" "$IMAGE_NAME")
            echo "size=$SIZE" >> $GITHUB_OUTPUT
            echo "‚úÖ Built successfully: $SIZE"
          else
            echo "size=Build Failed" >> $GITHUB_OUTPUT
            echo "‚ùå Build failed"
          fi

      - name: Save results
        run: |
          mkdir -p results
          
          NEW_SIZE="${{ steps.build_new.outputs.size }}"
          OLD_SIZE="${{ steps.build_old.outputs.size }}"
          BUILD_TIME="${{ steps.build_new.outputs.time }}"
          
          # If no old dockerfile, mark as ‚ùå
          if [ "${{ matrix.has_old }}" != "true" ]; then
            OLD_SIZE="‚ùå"
          fi
          
          # Create result JSON with safe filename
          SAFE_NAME=$(echo '${{ matrix.dir }}' | tr '/' '-')
          echo "{\"name\":\"${{ matrix.dir }}\",\"old_size\":\"$OLD_SIZE\",\"new_size\":\"$NEW_SIZE\",\"build_time\":\"$BUILD_TIME\"}" > "results/${SAFE_NAME}.json"

      - name: Upload result artifact
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ strategy.job-index }}
          path: results/*.json

  # Job 3: Compare results and comment on PR
  compare-and-comment:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Extract current README table
        id: current_table
        run: |
          echo "üìñ Extracting current table from README..."
          
          # Extract JSON-like data from current README table
          if grep -q "<!-- DOCKER_BUILD_RESULTS_START -->" README.md; then
            # Get table content between markers
            CURRENT_TABLE=$(sed -n '/<!-- DOCKER_BUILD_RESULTS_START -->/,/<!-- DOCKER_BUILD_RESULTS_END -->/p' README.md | grep "^|" | tail -n +3)
            echo "Current table found:"
            echo "$CURRENT_TABLE"
            
            # Parse table into JSON
            CURRENT_JSON="["
            FIRST=true
            while IFS='|' read -r _ name old_size new_size build_time _; do
              name=$(echo "$name" | xargs)
              old_size=$(echo "$old_size" | xargs)
              new_size=$(echo "$new_size" | xargs)
              build_time=$(echo "$build_time" | xargs)
              
              if [ -n "$name" ] && [ "$name" != "Imagen" ] && [ "$name" != "--------" ]; then
                if [ "$FIRST" = true ]; then
                  FIRST=false
                else
                  CURRENT_JSON+=","
                fi
                CURRENT_JSON+="{\"name\":\"$name\",\"old_size\":\"$old_size\",\"new_size\":\"$new_size\",\"build_time\":\"$build_time\"}"
              fi
            done <<< "$CURRENT_TABLE"
            CURRENT_JSON+="]"
            
            echo "$CURRENT_JSON" > current-results.json
            echo "Parsed JSON:"
            cat current-results.json
          else
            echo "[]" > current-results.json
            echo "No existing table found in README"
          fi

      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Download all result artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          path: all-results
          merge-multiple: true

      - name: Generate comparison comment
        id: compare
        run: |
          echo "üìä Generating comparison..."
          
          # Combine all JSON files into one array
          COMBINED="["
          FIRST=true
          
          for file in all-results/*.json; do
            if [ -f "$file" ]; then
              CONTENT=$(cat "$file")
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                COMBINED+=","
              fi
              COMBINED+="$CONTENT"
            fi
          done
          
          COMBINED+="]"
          
          echo "New results:"
          echo "$COMBINED" | jq .
          
          # Save new results
          echo "$COMBINED" > new-results.json
          
          # Generate new table
          NEW_TABLE=$(echo "$COMBINED" | jq -r '
            sort_by(.name) |
            "| Imagen | Dockerfile.old | Dockerfile (Optimizado) | Tiempo de Build |\n|--------|----------------|-------------------------|-----------------|\n" + 
            (map("| \(.name) | \(.old_size) | \(.new_size) | \(.build_time) |") | join("\n"))
          ')
          
          # Check if current-results.json exists and has data
          if [ -f "current-results.json" ] && [ "$(cat current-results.json)" != "[]" ]; then
            CURRENT_TABLE=$(cat current-results.json | jq -r '
              sort_by(.name) |
              "| Imagen | Dockerfile.old | Dockerfile (Optimizado) | Tiempo de Build |\n|--------|----------------|-------------------------|-----------------|\n" + 
              (map("| \(.name) | \(.old_size) | \(.new_size) | \(.build_time) |") | join("\n"))
            ')
            
            COMMENT="## üìä Comparativa de construcci√≥n de im√°genes Docker

### üÜï Resultados de esta PR

$NEW_TABLE

### üìå Resultados actuales en \`main\`

$CURRENT_TABLE

---
_Esta comparativa se genera autom√°ticamente para cada PR._"
          else
            COMMENT="## üìä Resultados de construcci√≥n de im√°genes Docker

$NEW_TABLE

> ‚ÑπÔ∏è No se encontr√≥ tabla de referencia en el README de \`main\`. Esta ser√° la primera tabla.

---
_Esta comparativa se genera autom√°ticamente para cada PR._"
          fi
          
          # Save comment to file (using heredoc to preserve newlines)
          cat << 'EOF' > comment.md
          $COMMENT
          EOF
          
          # Actually write the comment properly
          echo "$COMMENT" > comment.md
          
          echo "Comment generated:"
          cat comment.md

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('comment.md', 'utf8');
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('üìä Comparativa de construcci√≥n') || c.body.includes('üìä Resultados de construcci√≥n')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
              console.log('Created new comment');
            }
