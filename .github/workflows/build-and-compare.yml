name: Build and Compare Docker Images

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
  workflow_dispatch:

jobs:
  # Job 1: Discover all Dockerfiles and create the build matrix
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.find.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find all Dockerfiles
        id: find
        run: |
          # Find all Dockerfiles (excluding .old files)
          DOCKERFILES=$(find . -type f \( -iname "dockerfile" -o -iname "Dockerfile" \) ! -iname "*.old" | sort)
          
          echo "Found Dockerfiles:"
          echo "$DOCKERFILES"
          
          # Build JSON matrix
          MATRIX_JSON="["
          FIRST=true
          
          for dockerfile in $DOCKERFILES; do
            dir=$(dirname "$dockerfile" | sed 's|^\./||')
            dockerfile_name=$(basename "$dockerfile")
            
            # Check for .old dockerfile
            HAS_OLD="false"
            OLD_DOCKERFILE=""
            if [ -f "$dir/${dockerfile_name}.old" ]; then
              HAS_OLD="true"
              OLD_DOCKERFILE="${dockerfile_name}.old"
            elif [ -f "$dir/Dockerfile.old" ]; then
              HAS_OLD="true"
              OLD_DOCKERFILE="Dockerfile.old"
            elif [ -f "$dir/dockerfile.old" ]; then
              HAS_OLD="true"
              OLD_DOCKERFILE="dockerfile.old"
            fi
            
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              MATRIX_JSON+=","
            fi
            
            MATRIX_JSON+="{\"dir\":\"$dir\",\"dockerfile\":\"$dockerfile_name\",\"has_old\":$HAS_OLD,\"old_dockerfile\":\"$OLD_DOCKERFILE\"}"
          done
          
          MATRIX_JSON+="]"
          
          echo "Matrix JSON:"
          echo "$MATRIX_JSON"
          
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  # Job 2: Build each Dockerfile in parallel
  build:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build optimized Dockerfile
        id: build_new
        run: |
          echo "ðŸ“¦ Building ${{ matrix.dir }}/${{ matrix.dockerfile }}..."
          
          IMAGE_NAME="test-new-$(echo '${{ matrix.dir }}' | tr '/' '-')"
          
          # Measure build time
          START_TIME=$(date +%s)
          
          if docker build -t "$IMAGE_NAME" -f "${{ matrix.dir }}/${{ matrix.dockerfile }}" "${{ matrix.dir }}"; then
            END_TIME=$(date +%s)
            BUILD_TIME=$((END_TIME - START_TIME))
            
            # Format time as minutes:seconds
            MINUTES=$((BUILD_TIME / 60))
            SECONDS=$((BUILD_TIME % 60))
            if [ $MINUTES -gt 0 ]; then
              TIME_STR="${MINUTES}m ${SECONDS}s"
            else
              TIME_STR="${SECONDS}s"
            fi
            
            SIZE=$(docker images --format "{{.Size}}" "$IMAGE_NAME")
            echo "size=$SIZE" >> $GITHUB_OUTPUT
            echo "time=$TIME_STR" >> $GITHUB_OUTPUT
            echo "âœ… Built successfully: $SIZE in $TIME_STR"
          else
            END_TIME=$(date +%s)
            BUILD_TIME=$((END_TIME - START_TIME))
            echo "size=Build Failed" >> $GITHUB_OUTPUT
            echo "time=-" >> $GITHUB_OUTPUT
            echo "âŒ Build failed after ${BUILD_TIME}s"
          fi

      - name: Build old Dockerfile
        id: build_old
        if: matrix.has_old == true
        run: |
          echo "ðŸ“¦ Building ${{ matrix.dir }}/${{ matrix.old_dockerfile }}..."
          
          IMAGE_NAME="test-old-$(echo '${{ matrix.dir }}' | tr '/' '-')"
          
          if docker build -t "$IMAGE_NAME" -f "${{ matrix.dir }}/${{ matrix.old_dockerfile }}" "${{ matrix.dir }}"; then
            SIZE=$(docker images --format "{{.Size}}" "$IMAGE_NAME")
            echo "size=$SIZE" >> $GITHUB_OUTPUT
            echo "âœ… Built successfully: $SIZE"
          else
            echo "size=Build Failed" >> $GITHUB_OUTPUT
            echo "âŒ Build failed"
          fi

      - name: Save results
        run: |
          mkdir -p results
          
          NEW_SIZE="${{ steps.build_new.outputs.size }}"
          OLD_SIZE="${{ steps.build_old.outputs.size }}"
          BUILD_TIME="${{ steps.build_new.outputs.time }}"
          
          # If no old dockerfile, mark as âŒ
          if [ "${{ matrix.has_old }}" != "true" ]; then
            OLD_SIZE="âŒ"
          fi
          
          # Create result JSON with safe filename
          SAFE_NAME=$(echo '${{ matrix.dir }}' | tr '/' '-')
          echo "{\"name\":\"${{ matrix.dir }}\",\"old_size\":\"$OLD_SIZE\",\"new_size\":\"$NEW_SIZE\",\"build_time\":\"$BUILD_TIME\"}" > "results/${SAFE_NAME}.json"

      - name: Upload result artifact
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ strategy.job-index }}
          path: results/*.json

  # Job 3: Aggregate results and update README
  update-readme:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all result artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          path: all-results
          merge-multiple: true

      - name: Aggregate results and generate table
        id: aggregate
        run: |
          echo "ðŸ“Š Aggregating results..."
          
          # Combine all JSON files into one array
          COMBINED="["
          FIRST=true
          
          for file in all-results/*.json; do
            if [ -f "$file" ]; then
              CONTENT=$(cat "$file")
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                COMBINED+=","
              fi
              COMBINED+="$CONTENT"
            fi
          done
          
          COMBINED+="]"
          
          echo "Combined results:"
          echo "$COMBINED" | jq .
          
          # Sort by name and generate table
          FULL_TABLE=$(echo "$COMBINED" | jq -r '
            sort_by(.name) |
            "| Imagen | Dockerfile.old | Dockerfile (Optimizado) | Tiempo de Build |\n|--------|----------------|-------------------------|-----------------|\n" + 
            (map("| \(.name) | \(.old_size) | \(.new_size) | \(.build_time) |") | join("\n"))
          ')
          
          echo "Generated table:"
          echo "$FULL_TABLE"
          
          # Save table to file for next step
          echo "$FULL_TABLE" > table.md

      - name: Update README
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          FULL_TABLE=$(cat table.md)
          
          # Check if the results section already exists
          if grep -q "<!-- DOCKER_BUILD_RESULTS_START -->" README.md; then
            # Create new content between markers
            {
              sed -n '1,/<!-- DOCKER_BUILD_RESULTS_START -->/p' README.md
              echo ""
              echo "$FULL_TABLE"
              echo ""
              sed -n '/<!-- DOCKER_BUILD_RESULTS_END -->/,$p' README.md
            } > README.tmp && mv README.tmp README.md
          else
            # Append new section before "How contribute" section
            echo "" >> README.md
            echo "## ðŸ“Š Comparativa de tamaÃ±os de imÃ¡genes Docker" >> README.md
            echo "" >> README.md
            echo "Esta tabla muestra la diferencia de tamaÃ±o entre los Dockerfiles sin optimizar (\`.old\`) y los Dockerfiles optimizados." >> README.md
            echo "" >> README.md
            echo "<!-- DOCKER_BUILD_RESULTS_START -->" >> README.md
            echo "" >> README.md
            echo "$FULL_TABLE" >> README.md
            echo "" >> README.md
            echo "<!-- DOCKER_BUILD_RESULTS_END -->" >> README.md
          fi
          
          echo "README updated!"

      - name: Commit and push changes
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes
          if git diff --quiet README.md; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Configure remote with PAT for push
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git
          
          # Commit and push directly to main
          git add README.md
          git commit -m "ðŸ“Š Update Docker image size comparison table"
          git push
